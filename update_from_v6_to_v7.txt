Fixing the thread safety issues causing the Excel attachment crash. Suggest this the step-by-step solution:

üîß *Key Fixes Needed*

Thread-GUI Separation
Move all GUI updates to main thread signals
Remove direct GUI access from worker threads
Add proper progress signaling

üõ†Ô∏è *Modified Code Sections*

Add Progress Signal in ModernChatWindow

python:
class ModernChatWindow(QMainWindow):
    progress_updated = pyqtSignal(int)  # Add this at class level

    def __init__(self):
        # ... existing code ...
        self.progress_updated.connect(self._update_progress_bar)  # Add this line
Update Progress Handling

python:
def _update_progress_bar(self, value):
    """Handle progress updates from any thread"""
    self.progress_bar.setValue(value)
Modify File Processing Methods
In process_image, process_pdf, and process_office:

python:
def process_image(self, file_path):
    try:
        self.progress_updated.emit(10)  # Replace progress_bar access
        # ... rest of processing ...
        self.progress_updated.emit(100)
Update FileProcessingThread
Remove GUI operations from thread:

python:
class FileProcessingThread(QThread):
    finished = pyqtSignal(str, str)
    error = pyqtSignal(str)

    def run(self):
        try:
            # Only process data here, no GUI operations
            if file_type == 'image':
                content = self._process_image(file_path)
            # ...
            self.finished.emit(content, file_path)
Connect Progress Signal in Attachment Handler

python:
def _process_file_content(self, file_path):
    self.file_processor_thread = FileProcessingThread(file_path)
    self.file_processor_thread.progress.connect(self.progress_updated)  # Add this
    self.file_processor_thread.finished.connect(self._handle_processed_content)
üìù Critical Changes Summary
Signal-Based Progress

python:
# Was (thread-unsafe):
self.progress_bar.setValue(10)

# Now (thread-safe):
self.progress_updated.emit(10)
GUI Updates Only via Signals
Ensure all label/text updates happen through:

python:
self.finished.emit(processed_content)  # Worker thread

python:
# Handled in main thread:
def _handle_processed_content(self, text):
    self.chat_display.append(text)  # Now thread-safe
Removed Direct GUI Access
Eliminated all:

python:
QApplication.processEvents()  # Was causing recursive repaints

‚úÖ *Testing Checklist*

Attach small Excel file (<1MB)
Try with image/PDF files
Monitor system resources during processing
Check logs for thread warnings

üåü *Expected Outcome*

No more cross-thread GUI errors
Smooth file processing with progress updates
Stable application during file attachments

